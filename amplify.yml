version: 1
applications:
  - appRoot: .
    backend:
      phases:
        preBuild:
          commands:
            # Clean install for backend dependencies
            - echo "🧩 Installing backend dependencies..."
            - npm ci --cache .npm --prefer-offline

        build:
          commands:
            # Generate backend CDK artifacts (required for Amplify Gen 2)
            - echo "🏗️ Generating Amplify backend artifacts..."
            - npx ampx generate

            # Deploy the backend to Amplify environment
            - echo "🚀 Deploying Amplify backend..."
            - npx ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID

      artifacts:
        baseDirectory: .amplify/artifacts
        files:
          - '**/*'

      cache:
        paths:
          - .npm/**/*
          - node_modules/**/*

    frontend:
      phases:
        preBuild:
          commands:
            - echo "🧩 Installing frontend dependencies..."
            - npm ci --cache .npm --prefer-offline

        build:
          commands:
            - echo "🛠️ Building Next.js frontend..."
            - npm run build

      artifacts:
        baseDirectory: .next
        files:
          - '**/*'

      cache:
        paths:
          - .next/cache/**/*
          - .npm/**/*
          - node_modules/**/*

    # Optional logging & better failure visibility
    customHeaders:
      - pattern: '**/*'
        headers:
          - key: Cache-Control
            value: max-age=31536000
