version: 1

backend:
  phases:
    preBuild:
      commands:
        - echo "ğŸ§© Installing backend dependencies..."
        - npm ci --cache .npm --prefer-offline
        #
        # ğŸ‘‡ ADD THIS LINE ğŸ‘‡
        # Create a dummy outputs file to pass backend type-check
        - echo "{}" > amplify_outputs.json
        #
    build:
      commands:
        - echo "ğŸš€ Pushing backend to ensure latest Auth + secrets..."
        - npx ampx pipeline-deploy --app-id $AWS_APP_ID --branch $AWS_BRANCH

  artifacts:
    baseDirectory: .amplify/artifacts
    files:
      - '**/*'
  cache:
    paths:
      - .npm/**/*
      - node_modules/**/*

frontend:
  phases:
    preBuild:
      commands:
        - echo "ğŸ§© Installing frontend dependencies..."
        - npm ci --cache .npm --prefer-offline
        - echo "ğŸ§¾ Generating Amplify outputs..."
        - npx ampx generate outputs --app-id $AWS_APP_ID --branch $AWS_BRANCH
    build:
      commands:
        - echo "âš™ï¸ Writing environment variables to .env.production..."
        - env | grep -e GHL_CLIENT_ID -e GHL_CLIENT_SECRET -e BRIDGE_API_KEY -e GOOGLE_MAPS_API_KEY -e OPENAI_API_KEY -e GOOGLE_CLIENT_ID -e GOOGLE_CLIENT_SECRET >> .env.production
        - env | grep -e NEXT_PUBLIC_ >> .env.production
        - echo "âœ… Environment variables written to .env.production"
        - echo "ğŸ—ï¸ Building Next.js application..."
        - npm run build
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - .next/cache/**/*
      - .npm/**/*
      - node_modules/**/*
